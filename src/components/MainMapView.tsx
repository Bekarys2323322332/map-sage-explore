import { useEffect, useRef } from "react";
import L from "leaflet";
import "leaflet/dist/leaflet.css";

interface MainMapViewProps {
  onCountryClick: (country: string) => void;
  hoveredCountry: string | null;
  setHoveredCountry: (country: string | null) => void;
}

const MainMapView = ({ onCountryClick, hoveredCountry, setHoveredCountry }: MainMapViewProps) => {
  const mapRef = useRef<L.Map | null>(null);
  const containerRef = useRef<HTMLDivElement | null>(null);
  const countryLayersRef = useRef<Map<string, L.GeoJSON>>(new Map());

  // Simplified GeoJSON for Central Asian countries
  // Accurate GeoJSON for Central Asian countries
  const countriesGeoJSON = {
    type: "FeatureCollection",
    features: [
      {
        type: "Feature",
        properties: { name: "Kazakhstan", id: "kazakhstan" },
        geometry: {
          type: "Polygon",
          coordinates: [
            [
              [46.5, 49.6],
              [47.7, 50.5],
              [50.7, 51.6],
              [55.0, 51.2],
              [58.0, 52.0],
              [61.1, 53.5],
              [64.5, 54.7],
              [69.0, 55.4],
              [73.0, 54.0],
              [76.0, 54.4],
              [79.0, 53.1],
              [83.0, 49.8],
              [85.6, 48.4],
              [87.4, 49.2],
              [85.1, 47.1],
              [83.0, 47.4],
              [80.8, 45.0],
              [78.3, 42.9],
              [74.3, 42.9],
              [71.2, 42.8],
              [69.1, 41.0],
              [66.7, 41.1],
              [63.4, 43.5],
              [59.8, 44.3],
              [55.8, 45.2],
              [53.8, 46.3],
              [50.8, 46.7],
              [48.2, 47.8],
              [46.5, 49.6],
            ],
          ],
        },
      },
      {
        type: "Feature",
        properties: { name: "Uzbekistan", id: "uzbekistan" },
        geometry: {
          type: "Polygon",
          coordinates: [
            [
              [58.2859259, 44.67626910000004],
              [58.217141799999965, 44.858994100000025],
              [58.587577, 45.590118],
              [55.998742600000014, 45.0003137],
              [55.99857809999999, 43.75327009999999],
              [56.0017921, 41.32427980000002],
              [57.042415, 41.26321450000003],
              [56.9675751, 41.80456620000004],
              [57.1553981, 42.20921050000004],
              [57.341994, 42.35906809999999],
              [57.60017270000004, 42.253951099999966],
              [57.928524699999954, 42.24513909999996],
              [58.04018920000002, 42.50415249999997],
              [58.3033275, 42.45519110000004],
              [58.281238500000036, 42.68523659999999],
              [58.63975870000004, 42.740409],
              [59.01460639999998, 42.527025200000026],
              [59.1608238, 42.52898039999997],
              [59.434329499999976, 42.292651199999966],
              [59.921286600000016, 42.275169800000036],
              [60.17218609999996, 41.8447428],
              [60.093114, 41.4131935],
              [60.4758148, 41.221381],
              [60.998957800000035, 41.24233890000002],
              [61.2403842, 41.145332599999975],
              [61.6092268, 41.2562066],
              [61.97087950000002, 41.01913730000004],
              [62.11307250000004, 40.596107],
              [62.34945989999998, 40.438297300000016],
              [62.48794929999998, 39.9513942],
              [63.420414399999984, 39.445389600000034],
              [63.70514920000003, 39.22386589999998],
              [64.181194, 38.96186030000002],
              [64.35485229999998, 38.97673469999998],
              [64.82045090000001, 38.683030100000025],
              [65.5638476, 38.28832769999999],
              [66.24552149999995, 38.15404050000004],
              [66.40000820000002, 38.032485],
              [66.6766291, 37.96196860000003],
              [66.5482249, 37.79177409999996],
              [66.593677, 37.368724],
              [67.044771, 37.380436],
              [67.2700357, 37.18211640000004],
              [67.51681019999997, 37.265154200000026],
              [67.788453, 37.189087],
              [67.8303895, 37.54431549999997],
              [68.40395250000002, 38.19890950000002],
              [68.15721330000004, 38.37427019999997],
              [68.070911, 38.533756],
              [68.196079, 38.938527],
              [68.094405, 39.022916],
              [67.7038, 39.00056],
              [67.6752467, 39.14514319999998],
              [67.4007018, 39.226376300000034],
              [67.45626390000002, 39.5737215],
              [67.79313660000001, 39.656958600000046],
              [67.93892040000004, 39.5988392],
              [68.5120318, 39.53064129999997],
              [68.63298420000001, 39.8523724],
              [68.87114839999997, 39.86399549999997],
              [69.03574959999997, 40.22873390000004],
              [69.30550680000005, 40.1950935],
              [69.27162689999999, 40.48790419999997],
              [69.36242420000002, 40.76708820000001],
              [69.6692671, 40.63413749999998],
              [70.06817280000001, 40.755183],
              [70.551876, 40.979663],
              [70.79464859999999, 40.734526400000036],
              [70.49482630000003, 40.51138240000003],
              [70.63233, 40.177295],
              [71.20351630000003, 40.345055699999975],
              [71.734687, 40.162522300000035],
              [72.1592061, 40.4831718],
              [72.41050830000003, 40.40123860000002],
              [72.47598489999997, 40.55124590000001],
              [72.6926004, 40.5972143],
              [72.9910705, 40.76466970000001],
              [72.5913415, 40.86796229999998],
              [72.45340320000003, 41.027796899999956],
              [72.23772070000001, 41.00204650000001],
              [71.8863646, 41.1678132],
              [71.925132, 41.29422149999997],
              [71.74218420000003, 41.452167299999985],
              [71.36523510000004, 41.16266359999998],
              [70.96260040000004, 41.165755199999985],
              [70.66599619999998, 41.470175299999966],
              [70.48800870000002, 41.39817359999998],
              [70.21305590000004, 41.61081220000003],
              [70.49669270000001, 41.71968739999996],
              [70.66496139999998, 41.90695090000003],
              [70.8539149, 41.94151690000001],
              [71.26909269999996, 42.19636970000003],
              [71.0250738, 42.29240649999997],
              [70.7984498, 42.20746529999997],
              [70.634422, 42.015434],
              [70.47597970000004, 42.10930789999998],
              [69.9576833, 41.733773499999984],
              [69.617774, 41.663055],
              [68.57906959999997, 40.92504739999998],
              [68.61041989999998, 40.57707489999998],
              [68.2178103, 40.687503900000046],
              [67.9655608, 41.15007719999997],
              [67.733055, 41.183135],
              [67.364295, 41.127079],
              [66.706581, 41.141586],
              [66.53239280000003, 41.87743679999998],
              [65.99871, 41.937179],
              [66.001937, 42.360736],
              [66.095024, 42.566158],
              [66.09669309999998, 42.938137499999975],
              [65.84415579999998, 42.85825459999999],
              [65.55925819999996, 43.289475],
              [65.184862, 43.49516169999998],
              [64.93226339999997, 43.73537439999997],
              [64.53486069999998, 43.57068720000004],
              [63.34907640000002, 43.65048459999996],
              [62.004055, 43.505401],
              [61.13776079999997, 44.225787100000026],
              [60.99041769999997, 44.4125943],
              [59.991375, 45.002986],
              [59.5802784, 44.8842253],
              [59.56165407028315, 45.13215829843671],
              [58.74735914728734, 45.506368852486425],
              [58.64284409999998, 45.28533270000001],
              [58.691587399999975, 45.14251880000004],
              [58.58851830000002, 44.93188060000004],
              [58.586906, 44.569853599999966],
              [58.260583100000034, 44.42020220000003],
              [58.2859259, 44.67626910000004],
            ],
          ],
        },
      },
      {
        type: "Feature",
        properties: { name: "Kyrgyzstan", id: "kyrgyzstan" },
        geometry: {
          type: "Polygon",
          coordinates: [
            [
              [69.2649523, 39.8060382],
              [69.3283536, 39.7172191],
              [69.3377029, 39.5464437],
              [69.4477802, 39.5283061],
              [69.6294151, 39.5929759],
              [69.8268644, 39.5612367],
              [70.206628, 39.5784316],
              [70.3090689, 39.530032],
              [70.5249033, 39.6220846],
              [70.65013, 39.5822067],
              [70.7680286, 39.3993579],
              [71.0660553, 39.4142156],
              [71.0896762, 39.4991727],
              [71.2585761, 39.5489239],
              [71.5510257, 39.5873638],
              [71.5624396, 39.4548731],
              [71.7864695, 39.4434136],
              [71.7526699, 39.3239595],
              [71.918762, 39.280289],
              [72.0356292, 39.3664905],
              [72.2570039, 39.1751365],
              [72.3424373, 39.3320994],
              [72.4928576, 39.3800754],
              [72.6973229, 39.39556],
              [72.9588686, 39.346646],
              [73.1606836, 39.3524908],
              [73.3532063, 39.3933427],
              [73.5140207, 39.4745183],
              [73.8738476, 39.4828942],
              [73.9454978, 39.5987983],
              [73.8490521, 39.835949],
              [73.9830141, 40.0486202],
              [74.2572009, 40.1335889],
              [74.3445846, 40.0935122],
              [74.5904952, 40.2822165],
              [74.8553123, 40.393763],
              [74.8377744, 40.5220452],
              [75.0900968, 40.4348988],
              [75.2386193, 40.4608898],
              [75.5854371, 40.6623892],
              [75.6464025, 40.5056447],
              [75.7236068, 40.4728394],
              [75.6634264, 40.35486],
              [75.7182173, 40.2868025],
              [75.9241772, 40.3313094],
              [75.9748832, 40.3810971],
              [76.3346871, 40.3388985],
              [76.5353555, 40.4627264],
              [76.6542303, 40.6218004],
              [76.7533879, 40.9532527],
              [77.0013644, 41.0708322],
              [77.2765608, 41.0012922],
              [77.7651781, 41.0147841],
              [77.805803, 41.1256175],
              [78.1336456, 41.245688],
              [78.1865227, 41.3932146],
              [78.3818674, 41.3915945],
              [78.6450769, 41.4685484],
              [79.3227743, 41.8107657],
              [79.6377583, 41.8935242],
              [79.7652492, 41.8931398],
              [79.8544933, 42.0218932],
              [80.1986907, 42.036932],
              [80.1312877, 42.1683376],
              [80.125784, 42.303411],
              [79.967776, 42.432224],
              [79.673322, 42.480098],
              [79.504877, 42.459887],
              [79.1700054, 42.7550192],
              [78.930488, 42.774268],
              [78.542553, 42.868827],
              [77.968122, 42.85082],
              [77.780651, 42.914754],
              [77.549915, 42.939487],
              [77.349533, 42.900213],
              [77.1536, 42.972661],
              [76.851351, 42.978673],
              [76.708886, 42.904153],
              [76.522591, 42.922249],
              [76.343846, 42.860756],
              [76.185447, 42.931735],
              [76.028275, 42.911042],
              [75.8235176, 42.9402527],
              [75.7168122, 42.7973436],
              [75.4840633, 42.843361],
              [75.2312996, 42.853552],
              [74.8322904, 43.0039191],
              [74.7499278, 42.9897261],
              [74.5774809, 43.1328657],
              [74.3084266, 43.2163244],
              [73.8378589, 43.1278612],
              [73.5593832, 43.028858],
              [73.4329165, 42.5488984],
              [73.4871648, 42.4175902],
              [73.3147035, 42.4579934],
              [73.3097035, 42.5179218],
              [73.1200892, 42.5519331],
              [72.9107899, 42.5349882],
              [72.7442786, 42.6389054],
              [72.4989387, 42.6851377],
              [72.2820197, 42.7592688],
              [72.1203697, 42.7365025],
              [71.8636388, 42.8328097],
              [71.6372158, 42.7671364],
              [71.534108, 42.8014978],
              [71.2771306, 42.7803987],
              [71.17974, 42.610397],
              [71.002555, 42.587646],
              [70.955307, 42.402057],
              [70.8655832, 42.3201236],
              [70.988482, 42.2527095],
              [71.1334657, 42.2821769],
              [71.2690927, 42.1963697],
              [71.0289571, 42.0677232],
              [70.8789916, 42.0461255],
              [70.8539149, 41.9415169],
              [70.6649614, 41.9069509],
              [70.4966927, 41.7196874],
              [70.2082837, 41.6041965],
              [70.4880087, 41.3981736],
              [70.6659962, 41.4701753],
              [70.7795072, 41.3866135],
              [70.8408844, 41.2509917],
              [70.9626004, 41.1657552],
              [71.1271224, 41.14358],
              [71.2313872, 41.1926569],
              [71.4396409, 41.1269915],
              [71.4570387, 41.2953298],
              [71.5549876, 41.2906299],
              [71.7421842, 41.4521673],
              [71.9251902, 41.2945633],
              [71.8863646, 41.1678132],
              [72.0741646, 41.1216834],
              [72.2077951, 41.0293684],
              [72.4534032, 41.0277969],
              [72.5913415, 40.8679623],
              [72.832167, 40.8564321],
              [72.9910705, 40.7646697],
              [72.8013471, 40.6772639],
              [72.6158224, 40.5152294],
              [72.4321058, 40.6019073],
              [72.4105083, 40.4012386],
              [72.1592061, 40.4831718],
              [71.9663611, 40.319449],
              [71.734687, 40.1625223],
              [71.501476, 40.277068],
              [71.2737578, 40.3435988],
              [71.1311463, 40.3380805],
              [70.9833215, 40.2206414],
              [70.6699159, 40.1029762],
              [70.662617, 39.990517],
              [70.175289, 40.1429896],
              [69.995469, 40.2346763],
              [69.5184401, 40.080154],
              [69.2968843, 39.9204575],
              [69.2649523, 39.8060382],
            ],
          ],
        },
      },
      {
        type: "Feature",
        properties: { name: "Tajikistan", id: "tajikistan" },
        geometry: {
          type: "Polygon",
          coordinates: [
            [
              [70.451633, 41.03855260000004],
              [70.37182280000003, 40.89799680000003],
              [70.0681728, 40.755183],
              [69.6692671, 40.6341375],
              [69.3853798, 40.78600340000002],
              [69.30550680000003, 40.1950935],
              [69.03574959999997, 40.22873389999996],
              [68.93037619999996, 39.92662990000004],
              [68.6329842, 39.8523724],
              [68.61756750000002, 39.6372633],
              [68.51203179999999, 39.530641299999985],
              [67.93892040000003, 39.598839200000015],
              [67.7931366, 39.656958599999975],
              [67.40192250000001, 39.533434900000024],
              [67.4876085, 39.37823],
              [67.4007018, 39.226376299999956],
              [67.67524669999999, 39.1451432],
              [67.7038, 39.00056],
              [68.114973, 39.014054],
              [68.196079, 38.938527],
              [68.070911, 38.533756],
              [68.15721330000002, 38.374270199999984],
              [68.4039525, 38.198909500000035],
              [68.27851279999997, 37.9118508],
              [68.123592, 37.888161],
              [67.87869670000005, 37.6375557],
              [67.78985120000003, 37.418626400000015],
              [67.778889, 37.101667],
              [68.057222, 36.931944],
              [68.301667, 37.111111],
              [68.61700420000004, 37.19844650000003],
              [68.671389, 37.275556],
              [68.973889, 37.321944],
              [69.25620869999996, 37.09341020000002],
              [69.4037306, 37.168048899999974],
              [69.37041090000002, 37.380021499999984],
              [69.51156709999998, 37.58113],
              [69.94072320000002, 37.608060800000025],
              [70.11225440000003, 37.5244548],
              [70.28634710000004, 37.68377120000001],
              [70.18541880000002, 37.85006779999997],
              [70.49267119999996, 38.12072059999997],
              [70.61095450000002, 38.34639879999996],
              [70.77170249999999, 38.4559043],
              [71.16342019999998, 38.3869737],
              [71.37349740000002, 38.256597],
              [71.26075009999998, 37.92165329999998],
              [71.52421690000004, 37.95317680000002],
              [71.595603, 37.80507910000003],
              [71.49496290000002, 37.5386038],
              [71.4315087, 37.056938600000024],
              [71.5630946, 36.763797],
              [71.8436383, 36.6806171],
              [72.32570579999995, 36.98130159999999],
              [72.66251960000004, 37.01768690000004],
              [72.81526139999997, 37.231167799999966],
              [73.09417559999999, 37.32481560000004],
              [73.30664719999999, 37.46361080000004],
              [73.77589340000002, 37.440093799999964],
              [73.84295779999997, 37.23404489999999],
              [74.4835043, 37.411572],
              [74.80380040000004, 37.355417],
              [74.8880541, 37.257132],
              [75.15395630000005, 37.409563699999964],
              [74.9320979, 37.56850210000004],
              [74.96710130000002, 37.752198],
              [74.91647520000002, 38.0245825],
              [74.8202795, 38.08528960000001],
              [74.65073780000003, 38.4459372],
              [74.18688859999996, 38.64027970000003],
              [74.03932830000002, 38.54418650000004],
              [73.80371750000003, 38.611756],
              [73.69922130000005, 38.8777721],
              [73.81242359999999, 39.0428208],
              [73.61318820000002, 39.246771500000015],
              [73.51402070000005, 39.4745183],
              [73.3532063, 39.3933427],
              [72.95886860000003, 39.346646],
              [72.69732290000002, 39.39556],
              [72.34243730000001, 39.33209940000003],
              [72.25700389999997, 39.17513649999999],
              [72.03562919999997, 39.36649050000002],
              [71.56243959999998, 39.454873100000015],
              [71.55102569999998, 39.5873638],
              [71.08967619999999, 39.499172700000045],
              [71.06605530000002, 39.41421559999997],
              [70.76802860000002, 39.39935789999997],
              [70.52490330000002, 39.6220846],
              [70.206628, 39.5784316],
              [69.62941509999999, 39.5929759],
              [69.33770290000004, 39.5464437],
              [69.29688429999999, 39.92045750000003],
              [69.5821533, 40.1046068],
              [69.995469, 40.23467630000003],
              [70.175289, 40.142989600000035],
              [70.662617, 39.990517],
              [70.559969, 40.354172],
              [70.37895260000003, 40.38652],
              [70.79464859999999, 40.734526399999964],
              [70.451633, 41.03855260000004],
            ],
          ],
        },
      },
      {
        type: "Feature",
        properties: { name: "Turkmenistan", id: "turkmenistan" },
        geometry: {
          type: "Polygon",
          coordinates: [
            [
              [58.79547925056704, 42.61332345921045],
              [58.28597504171489, 42.64456265064592],
              [57.743810307899366, 42.1404334198665],
              [56.982532634673476, 41.86370529486351],
              [56.872835071681266, 41.29330160328652],
              [55.43144505254713, 41.30431779383122],
              [54.71291347727538, 42.04833867129281],
              [54.216473478768194, 42.27349155019505],
              [52.91658453594761, 42.06531354128691],
              [52.56711690562088, 41.63225836043523],
              [52.92638269370639, 40.95992278860592],
              [52.71461184196306, 40.04824995537132],
              [53.38977024000462, 39.97300328227584],
              [53.06368754594365, 39.44557085820867],
              [53.90946453296203, 38.95994320901195],
              [53.863739795855, 37.396494392302486],
              [54.77496847731345, 37.51316586771077],
              [55.47063768448169, 38.127195252658964],
              [57.26095708789944, 38.29010670835788],
              [57.40414083533136, 37.9806032041746],
              [58.43621346248136, 37.65810269958001],
              [58.91632319805717, 37.694292799173525],
              [60.340322140054866, 36.64025715384463],
              [61.17316555764461, 36.574712417344244],
              [61.215754883980765, 35.623121012225],
              [62.11378871147991, 35.3401452636931],
              [62.32608213228468, 35.07862980242362],
              [63.080279003273404, 35.381483458594914],
              [63.347666811773934, 35.811838871966415],
              [64.53005526523839, 36.27051518033136],
              [64.85155732001436, 37.17854638880493],
              [65.55579991623324, 37.2598228525427],
              [65.79054744800646, 37.567873845501765],
              [66.4539807172365, 37.33731140239934],
              [66.65686790483011, 38.03207244448777],
              [65.50395133108918, 38.34525162266442],
              [64.19099817792363, 39.00056573062409],
              [62.603696604814616, 39.93845411626455],
              [61.820252233154235, 41.19919249024133],
              [60.157073072064804, 41.37566983769295],
              [60.023515035590606, 42.19611000347396],
              [58.79547925056704, 42.61332345921045],
            ],
          ],
        },
      },
    ],
  };

  useEffect(() => {
    if (!containerRef.current || mapRef.current) return;

    // Initialize map centered on Central Asia
    mapRef.current = L.map(containerRef.current, {
      center: [45, 66],
      zoom: 5,
      minZoom: 4,
      maxZoom: 7,
      zoomControl: false,
      attributionControl: false,
    });

    // Add base tile layer
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "",
    }).addTo(mapRef.current);

    // Add country boundaries
    countriesGeoJSON.features.forEach((feature) => {
      const layer = L.geoJSON(feature as any, {
        style: {
          fillColor: "transparent",
          fillOpacity: 0.3,
          color: "hsl(var(--border))",
          weight: 2,
        },
        onEachFeature: (feature, layer) => {
          const countryId = feature.properties.id;

          layer.on({
            mouseover: () => setHoveredCountry(countryId),
            mouseout: () => setHoveredCountry(null),
            click: () => onCountryClick(countryId),
          });

          // Add country label
          if (feature.geometry.type === "Polygon") {
            const coords = feature.geometry.coordinates[0];
            const center = coords.reduce(
              (acc: [number, number], coord: number[]) => {
                return [acc[0] + coord[1] / coords.length, acc[1] + coord[0] / coords.length];
              },
              [0, 0],
            );

            L.marker([center[0], center[1]], {
              icon: L.divIcon({
                className: "country-label",
                html: `<div style="font-size: 14px; font-weight: 600; color: hsl(var(--foreground)); text-shadow: 1px 1px 2px rgba(255,255,255,0.8), -1px -1px 2px rgba(255,255,255,0.8); pointer-events: none; white-space: nowrap;">${feature.properties.name}</div>`,
                iconSize: [100, 20],
              }),
            }).addTo(mapRef.current!);
          }
        },
      }).addTo(mapRef.current!);

      countryLayersRef.current.set(feature.properties.id, layer);
    });

    return () => {
      if (mapRef.current) {
        mapRef.current.remove();
        mapRef.current = null;
      }
    };
  }, []);

  // Update styles based on hover state
  useEffect(() => {
    countryLayersRef.current.forEach((layer, id) => {
      layer.setStyle({
        fillColor: hoveredCountry === id ? "hsl(var(--primary))" : "transparent",
        fillOpacity: hoveredCountry === id ? 0.5 : 0.3,
        color: "hsl(var(--border))",
        weight: hoveredCountry === id ? 3 : 2,
      });
    });
  }, [hoveredCountry]);

  return <div ref={containerRef} className="w-full h-full" />;
};

export default MainMapView;
