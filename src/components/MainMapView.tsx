import { useEffect, useRef } from 'react';
import L from 'leaflet';
import 'leaflet/dist/leaflet.css';

interface MainMapViewProps {
  onCountryClick: (country: string) => void;
  hoveredCountry: string | null;
  setHoveredCountry: (country: string | null) => void;
}

const MainMapView = ({ onCountryClick, hoveredCountry, setHoveredCountry }: MainMapViewProps) => {
  const mapRef = useRef<L.Map | null>(null);
  const containerRef = useRef<HTMLDivElement | null>(null);
  const countryLayersRef = useRef<Map<string, L.GeoJSON>>(new Map());

  // Simplified GeoJSON for Central Asian countries
  const countriesGeoJSON = {
    type: "FeatureCollection",
    features: [
      {
        {"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[69.6837177,55.360181],[69.2061,55.3301],[68.935,55.4398],[68.7521,55.3768],[68.649153,55.20854770000001],[68.28074290000005,55.204402699999974],[68.23513390000004,54.9690517],[67.8194637,54.97123110000002],[67.77353110000003,54.88595620000003],[66.381721,54.703724],[65.998643,54.625148],[65.84528550000003,54.697243200000024],[65.212465,54.531772],[65.239194,54.37575],[64.974791,54.424178],[64.738648,54.35392],[64.48172759999997,54.3665596],[63.98407729999997,54.271569200000044],[63.15099630000002,54.18263010000002],[63.07957029999997,54.104119900000015],[62.339218,54.032274],[62.006056,54.037808],[61.857450299999975,53.962056699999984],[61.4800687,54.08297019999997],[61.293575,54.073881],[61.135364,53.904236],[61.227187,53.79567],[60.900425,53.627799],[61.215551699999985,53.56364440000003],[61.154711,53.405554],[61.225143,53.282833],[62.118862,53.111967],[61.960691,52.950035],[61.469686700000025,53.036211],[61.250433,53.035909],[60.712215,52.764534],[60.98097,52.507692],[61.067349,52.347597],[60.716655,52.156056],[60.510395,52.156918],[60.032716,51.913518],[60.428865,51.79832],[60.422119,51.6474006],[60.935626499999984,51.61526410000003],[60.99986650000001,51.468664299999986],[61.505234,51.406996],[61.567968,51.237725],[61.449163,50.8063336],[60.80864740000004,50.6562994],[60.325545699999964,50.66999790000002],[60.01534560000003,50.82191310000004],[59.9975098,50.674848099999956],[59.814103,50.5361125],[59.516941500000016,50.52807409999998],[59.418622100000036,50.636758],[58.87463530000005,50.69974440000002],[58.59203409999997,50.868707100000044],[58.6370453,50.985422],[58.34237990000003,51.146812099999984],[57.951559,51.086255],[57.77106820000003,51.138354299999975],[57.73602440000005,50.9277476],[57.32442730000004,50.94290639999996],[57.145399900000015,51.08756389999998],[56.6996787,51.074955700000025],[56.6339416,50.98523279999998],[56.3624428,50.900808500000025],[56.18134039999997,50.9378649],[56.053587699999966,50.69387070000004],[55.660772,50.56018869999998],[55.384687,50.65464149999996],[54.73302860000003,51.03041090000004],[54.67992859999998,50.71817220000001],[54.73019609999997,50.617504499999974],[54.543693900000015,50.527415600000026],[54.41394089999997,50.62095110000004],[54.53424289999999,50.84892220000003],[54.199581600000016,50.96394030000002],[54.0279203,51.162229],[53.66125859999996,51.23116660000002],[53.57521680000003,51.42458159999996],[53.3935775,51.4902611],[52.56543750000004,51.463557599999966],[52.335364699999964,51.743318699999975],[52.09006059999998,51.65837649999998],[51.89409490000002,51.68340839999998],[51.77107359999999,51.58201590000002],[51.4315407,51.47485310000002],[51.380206,51.641243099999976],[50.8936136,51.68137519999998],[50.5377167,51.5890327],[50.542586599999964,51.4644457],[50.251344199999984,51.281299499999975],[50.03868239999997,51.25125139999997],[49.77628879999997,51.107179],[49.39371159999998,51.09032990000004],[49.419855499999976,50.849118],[49.12603070000002,50.784780300000044],[48.81395169999997,50.595478100000044],[48.65218779999997,50.601063399999965],[48.73206649999996,50.257163],[48.9033674,50.01846630000004],[48.45043640000003,49.835094900000044],[48.2689583,49.85968110000003],[48.0952102,50.100013499999974],[47.612153700000015,50.46367759999997],[47.30013479999996,50.3033031],[47.3526454,50.0940359],[47.182360099999975,49.93502660000002],[46.90247210000004,49.86385150000003],[46.782086500000034,49.3398271],[46.99612120000004,49.232381899999986],[47.02867780000003,49.08929540000002],[46.77916489999997,48.951413700000025],[46.492161,48.4336187],[47.1237606,48.269529],[47.0499115,47.997515],[47.19408,47.76050369999998],[47.4150752,47.837710499999964],[47.652672799999976,47.75819640000003],[48.113718900000016,47.743257],[48.213354,47.69051459999998],[48.45301590000003,47.410845],[48.52064059999998,47.411572399999955],[48.711055,47.09533760000004],[48.99712520000003,46.7430848],[48.560284,46.6418742],[48.54499489999996,46.56330379999998],[49.163043899999984,46.38335730000003],[49.53502289999997,46.188516599999986],[49.839682,46.1927839],[49.9382582,46.5759493],[50.0386838,46.58103189999998],[50.21234649999996,46.763797599999954],[50.787240399999966,46.98019609999997],[50.8907419,47.0678535],[51.25208389999997,47.130114599999985],[51.58610870000003,47.070586700000014],[51.84033740000002,46.92811539999997],[51.98748120000004,47.004302799999984],[52.2274638,46.96729810000002],[52.423157800000034,47.047364800000025],[53.092637099999976,46.887345899999985],[53.12628280000001,46.73426089999999],[53.38034159999997,46.48993109999997],[53.39750780000002,46.300268],[53.10259349999998,45.851569499999975],[53.098533,45.76087029999998],[53.4548427,45.693758899999956],[53.621697500000046,45.4996578],[53.9687968,45.7697266],[54.2118693,45.79151519999998],[54.5946742,45.4264559],[54.94383339999997,45.23409030000003],[54.5383693,44.99811650000003],[54.0961898,44.991323899999955],[53.75335320000004,44.94640779999999],[53.55440629999998,44.79504180000002],[53.546166499999984,44.704583300000046],[53.2866145,44.36956390000002],[53.16061510000002,44.46177],[53.57534890000003,45.02602869999996],[53.941674300000045,45.149165],[53.603844700000025,45.288946],[53.4544993,45.29232749999996],[53.235116100000035,45.178939600000035],[52.871880599999976,45.19103860000004],[52.49319559999998,45.3222686],[52.308144700000014,45.3126119],[52.018036900000034,45.410068800000026],[51.7272426,45.4028376],[51.38803970000004,45.3058512],[51.2472773,45.16925849999998],[51.2778331,45.01413729999999],[51.19337569999997,44.88584520000003],[51.314475800000025,44.597411600000015],[51.09883269999999,44.47474170000001],[50.890221700000026,44.61276120000004],[50.31187089999999,44.64591279999996],[50.24855150000002,44.3855141],[50.42845260000003,44.2936793],[50.77417859999996,44.24106740000002],[50.8678861,44.0348247],[51.3149606,43.450320099999985],[51.28435619999997,43.14613860000003],[51.6221858,43.185202899999965],[51.90508370000001,42.83322850000004],[52.139962,42.880448600000044],[52.612608399999964,42.802826299999964],[52.73743350000003,42.73276769999998],[52.576322,42.31048449999999],[52.42391919999997,42.08009650000004],[52.49676809999998,41.7972993],[52.984788,42.121175],[53.570558,42.288924],[54.21780990000001,42.37908649999997],[54.779482,42.052549],[55.315465,41.390882],[55.499612,41.251587],[56.00179210000002,41.32427980000004],[55.99857810000001,43.7532701],[55.99874260000003,45.000313700000014],[57.432773,45.334335],[58.587577,45.590118],[58.7350914,45.85693989999997],[58.86728569999998,45.92620219999996],[58.925100499999964,45.650812199999955],[58.74735914728736,45.506368852486446],[59.0965967,45.322897299999966],[59.56165407028317,45.13215829843673],[59.65819119999997,45.471614100000025],[59.8923331,45.3276069],[59.86585331913014,45.0407172876808],[59.991375,45.002986],[60.9904177,44.412594300000016],[61.13776079999999,44.225787099999955],[62.004055,43.505401],[62.24249940000003,43.51855379999996],[63.349076400000044,43.650484599999984],[63.8576283,43.59925790000003],[64.5348607,43.570687199999966],[64.9322634,43.7353744],[65.184862,43.4951617],[65.55925819999999,43.289475],[65.8441558,42.8582546],[66.09669310000001,42.9381375],[66.095024,42.566158],[66.001937,42.360736],[65.99871,41.937179],[66.53239280000004,41.8774368],[66.706581,41.141586],[67.364295,41.127079],[67.733055,41.183135],[67.96556080000002,41.1500772],[68.088698,40.92553959999996],[67.97751749999998,40.831248600000045],[68.21781030000002,40.687503899999975],[68.6104199,40.5770749],[68.5790696,40.9250474],[68.80389290000004,41.115783],[69.039489,41.25521],[69.041404,41.365917],[69.30115179999997,41.43775],[69.617774,41.663055],[69.95768330000001,41.7337735],[70.157722,41.8494606],[70.320205,42.037025],[70.47597969999995,42.1093079],[70.634422,42.015434],[70.955307,42.402057],[71.001701,42.585495],[71.17974,42.610397],[71.28020689999995,42.7801265],[71.63721579999996,42.767136399999984],[71.86363880000003,42.83280970000003],[72.12036970000001,42.7365025],[72.2820197,42.75926879999996],[72.74427860000003,42.63890540000001],[72.91078989999998,42.534988199999965],[73.43291650000003,42.5488984],[73.55938320000004,43.028858],[73.95734760000005,43.18033120000002],[74.29378970000002,43.2418678],[74.57748090000004,43.13286569999997],[74.75168729999996,42.9898125],[74.85330389999999,42.99985180000003],[75.23129959999999,42.853552],[75.71681219999996,42.7973436],[75.8233452,42.93874149999996],[76.195291,42.930789],[76.343846,42.860756],[76.522591,42.922249],[76.708886,42.904153],[76.851351,42.978673],[77.154973,42.972254],[77.233629,42.912064],[77.779468,42.914801],[77.967561,42.850948],[78.350308,42.855175],[78.491834,42.900669],[78.930488,42.774268],[79.19937189999999,42.80422309999998],[79.18201470000002,42.69754229999998],[79.504877,42.459887],[79.967776,42.432224],[80.232071,42.34880930000002],[80.16268770000005,42.624882499999984],[80.27733670000005,42.8379769],[80.52717810000001,42.8779792],[80.38776079999998,43.002888],[80.58659219999998,43.136405600000025],[80.78131150000002,43.137824099999975],[80.7509765,43.469037300000025],[80.52276650000005,43.821915],[80.39426469999997,44.112030800000014],[80.34692,44.48268640000001],[80.41048259999998,44.610393],[79.88198539999996,44.91067759999996],[80.15236740000003,45.052702],[80.69794930000002,45.133513399999956],[80.89827580000002,45.12510519999997],[81.11960480000005,45.215173299999975],[81.45183319999998,45.262192],[81.632353,45.3565891],[81.8021953,45.35601539999996],[81.92203459999999,45.228887],[82.581643,45.21961710000004],[82.54283160000001,45.42095810000004],[82.27995879999997,45.5351376],[82.33565640000002,45.93915830000002],[82.45610689999998,45.977168300000024],[82.51189590000003,46.15462879999998],[82.73977839999998,46.51816309999999],[82.78761669999996,46.6922385],[83.05162570000005,47.225277],[83.35397869999996,47.17455959999997],[83.57797150000003,47.06054],[83.915311,46.974110899999985],[84.73620610000003,47.01406860000004],[84.944232,46.8628509],[85.2993583,47.064983699999964],[85.56083349999996,47.059913700000045],[85.68226850000002,47.222829799999985],[85.68025409999997,47.43410410000004],[85.54717719999996,48.01017340000004],[85.59212489999999,48.19897080000002],[85.755394,48.3981667],[86.20457459999999,48.43076709999996],[86.58326550000004,48.539936099999956],[86.773135,48.720619],[86.727072,48.950636],[86.887155,49.132579],[87.104137,49.151124],[86.83095280000003,49.46975290000004],[86.602492,49.60555329999996],[86.37135080000002,49.59362189999996],[85.9689905,49.48711619999997],[85.88373720000001,49.56690680000004],[85.21012460000003,49.627085500000035],[85.19830690000003,49.73793919999998],[84.85636310000004,50.09211279999997],[84.62818690000003,50.21067889999997],[84.4098473,50.20922639999996],[84.251587,50.290141099999964],[84.17615080000004,50.55161049999997],[83.96433639999998,50.8009987],[83.648704,50.95477659999996],[83.4071645,51.01318869999998],[83.20204540000003,50.99333780000001],[82.7391939,50.85043189999998],[82.56746960000002,50.746842399999956],[82.22243669999997,50.736917100000035],[81.88541540000004,50.804307],[81.44933820000003,50.755926],[81.41258740000004,50.975741800000016],[81.05976349999999,50.94790339999997],[81.17697569999997,51.161705900000044],[80.67767319999996,51.316749800000025],[80.4470866,51.2082857],[80.48224289999999,50.96868710000002],[80.083038,50.8281677],[79.73165389999998,51.1910062],[79.11191209999996,52.00308549999997],[78.30600189999998,52.884452900000035],[77.9065061,53.29141],[76.53783129999995,53.99985260000004],[76.434915,54.1225724],[76.75646579999997,54.161826],[76.8785671,54.30176019999997],[76.25728970000003,54.35927139999996],[76.2013926,54.25979870000004],[75.59810750000004,54.09879260000003],[75.375585,54.07010430000001],[75.3774621,53.95955639999996],[75.04658130000001,53.79269670000004],[74.7946,53.8245],[74.4865,53.5694],[74.28685039999998,53.56077830000003],[73.901147,53.65122139999998],[73.82134530000003,53.578387],[73.39788450000003,53.5221518],[73.23842510000003,53.5675771],[73.5104,53.9378],[73.06696829999996,53.985537],[72.99458090000003,54.098412],[72.60879339999998,54.1368406],[72.4331,54.0447],[72.29902909999996,54.186814500000025],[71.7555,54.2522],[71.7227,54.1038],[71.296101,54.18494489999996],[71.1794006,54.0945994],[70.9983,54.3338],[71.2267,54.3494],[71.1724,54.5734],[70.9601,54.8859],[70.9924,55.0669],[70.8043,55.2694],[70.47800290000004,55.27294249999997],[70.2294,55.1471],[69.9517,55.2097],[69.6837177,55.360181]]]},"properties":{name: "Kazakhstan", id: "kazakhstan", "shapeName":"Kazakhstan","shapeISO":"KAZ","shapeID":"12445969B25401373275960","shapeGroup":"KAZ","shapeType":"ADM0"}}
]},
      {
        type: "Feature",
        properties: { name: "Uzbekistan", id: "uzbekistan" },
        geometry: {
          type: "Polygon",
          coordinates: [[
            [55.5, 37], [56, 41.5], [60, 42], [66, 43], [69, 41],
            [69, 38], [68, 37.5], [66, 37], [64, 37.5], [60, 38],
            [57, 37.2], [55.5, 37]
          ]]
        }
      },
      {
        type: "Feature",
        properties: { name: "Kyrgyzstan", id: "kyrgyzstan" },
        geometry: {
          type: "Polygon",
          coordinates: [[
            [69, 43], [74, 43], [80, 42], [80, 40], [78, 39.5],
            [75, 39], [72, 39.5], [70, 40], [69, 41.5], [69, 43]
          ]]
        }
      },
      {
        type: "Feature",
        properties: { name: "Tajikistan", id: "tajikistan" },
        geometry: {
          type: "Polygon",
          coordinates: [[
            [67, 37], [68, 38.5], [69, 39], [71, 39], [73, 38.5],
            [75, 39], [75, 37.5], [73, 37], [71, 37], [69, 37],
            [67, 37]
          ]]
        }
      },
      {
        type: "Feature",
        properties: { name: "Turkmenistan", id: "turkmenistan" },
        geometry: {
          type: "Polygon",
          coordinates: [[
            [52.5, 35], [53, 39], [55, 40], [58, 40], [61, 39],
            [66, 39], [66, 37], [63, 35.5], [60, 35], [56, 35],
            [52.5, 35]
          ]]
        }
      }
    ]
  };

  useEffect(() => {
    if (!containerRef.current || mapRef.current) return;

    // Initialize map centered on Central Asia
    mapRef.current = L.map(containerRef.current, {
      center: [45, 66],
      zoom: 5,
      minZoom: 4,
      maxZoom: 7,
      zoomControl: false,
      attributionControl: false,
    });

    // Add base tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '',
    }).addTo(mapRef.current);

    // Add country boundaries
    countriesGeoJSON.features.forEach((feature) => {
      const layer = L.geoJSON(feature as any, {
        style: {
          fillColor: 'transparent',
          fillOpacity: 0.3,
          color: 'hsl(var(--border))',
          weight: 2,
        },
        onEachFeature: (feature, layer) => {
          const countryId = feature.properties.id;
          
          layer.on({
            mouseover: () => setHoveredCountry(countryId),
            mouseout: () => setHoveredCountry(null),
            click: () => onCountryClick(countryId),
          });

          // Add country label
          if (feature.geometry.type === 'Polygon') {
            const coords = feature.geometry.coordinates[0];
            const center = coords.reduce((acc: [number, number], coord: number[]) => {
              return [acc[0] + coord[1] / coords.length, acc[1] + coord[0] / coords.length];
            }, [0, 0]);
            
            L.marker([center[0], center[1]], {
              icon: L.divIcon({
                className: 'country-label',
                html: `<div style="font-size: 14px; font-weight: 600; color: hsl(var(--foreground)); text-shadow: 1px 1px 2px rgba(255,255,255,0.8), -1px -1px 2px rgba(255,255,255,0.8); pointer-events: none; white-space: nowrap;">${feature.properties.name}</div>`,
                iconSize: [100, 20],
              }),
            }).addTo(mapRef.current!);
          }
        },
      }).addTo(mapRef.current!);

      countryLayersRef.current.set(feature.properties.id, layer);
    });

    return () => {
      if (mapRef.current) {
        mapRef.current.remove();
        mapRef.current = null;
      }
    };
  }, []);

  // Update styles based on hover state
  useEffect(() => {
    countryLayersRef.current.forEach((layer, id) => {
      layer.setStyle({
        fillColor: hoveredCountry === id ? 'hsl(var(--primary))' : 'transparent',
        fillOpacity: hoveredCountry === id ? 0.5 : 0.3,
        color: 'hsl(var(--border))',
        weight: hoveredCountry === id ? 3 : 2,
      });
    });
  }, [hoveredCountry]);

  return <div ref={containerRef} className="w-full h-full" />;
};

export default MainMapView;
